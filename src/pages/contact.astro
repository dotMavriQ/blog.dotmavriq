---
import BaseLayout from "../layouts/BaseLayout.astro";
import ContactIcons from "../components/ContactIcons.astro";
import "../styles/global.css";
---

<BaseLayout title="Contact · dotMavriQ" description="Ways to reach me, book time, or donate.">
  <section class="relative z-30 mx-auto px-6 md:px-10 py-8 md:py-14 max-w-5xl select-none">

    <!-- Main contact card with socials and frayed corner; click opens QR modal -->
    <article
      id="contact-card"
      class="contact-card frayed group relative mx-auto max-w-3xl p-0 bg-transparent cursor-default"
      aria-controls="qr-modal"
      aria-haspopup="dialog"
    >
      <div class="bite-shape" aria-hidden="true"></div>
      <div class="bite-edge" aria-hidden="true"></div>
      <!-- Crumb dots scattered near the bite -->
      <div class="bite-crumbs" aria-hidden="true">
        <span style="top:22px;right:46px;width:3px;height:3px;opacity:.5"></span>
        <span style="top:42px;right:66px;width:2px;height:2px;opacity:.4"></span>
        <span style="top:60px;right:72px;width:3px;height:2px;opacity:.35;transform:rotate(20deg)"></span>
        <span style="top:10px;right:40px;width:2px;height:2px;opacity:.3"></span>
        <span style="top:72px;right:80px;width:2px;height:2px;opacity:.25;transform:rotate(-10deg)"></span>
      </div>
      <button id="fold-trigger" class="fold-hit" type="button" aria-label="Open QR" title="Open QR" aria-expanded="false"></button>
  <div class="surface rounded-2xl bg-gruv-surface/80 border border-gruv-surface2/90 p-6 md:p-8">
      <header class="mb-4 flex items-start justify-between gap-4">
        <div>
          <h2 class="text-2xl md:text-3xl font-bold text-gruv-fg tracking-tight">Let’s connect</h2>
          <p class="mt-1 text-[15px] leading-relaxed text-gruv-fg/85">
            Prefer async? Ping me on any channel below. I read all DMs and reply when I can.
          </p>
        </div>
      </header>
      <div class="mt-2">
        <ContactIcons />
      </div>
      </div>
    </article>

    <!-- Secondary actions: Donate + Book a meeting -->
    <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-6 max-w-3xl mx-auto">
      <!-- Donate card -->
  <section class="rounded-xl border border-gruv-surface2 bg-gruv-surface/70 p-5 shadow-sm">
        <header class="flex items-center gap-3">
          <h3 class="text-xl font-semibold tracking-tight text-gruv-fg">Donate</h3>
          <!-- 8-bit heart (SVG pixels) in gruvbox dark red; sized to match text-xl (1.25rem) -->
          <svg viewBox="0 0 11 10" aria-hidden="true" class="h-[1.25rem] w-auto drop-shadow">
            <g fill="#cc241d" shape-rendering="crispEdges">
              <!-- Row 0: .11..11. -->
              <rect x="1" y="0" width="1" height="1"/>
              <rect x="2" y="0" width="1" height="1"/>
              <rect x="5" y="0" width="1" height="1"/>
              <rect x="6" y="0" width="1" height="1"/>
              <!-- Row 1: 11111111 -->
              <rect x="0" y="1" width="1" height="1"/>
              <rect x="1" y="1" width="1" height="1"/>
              <rect x="2" y="1" width="1" height="1"/>
              <rect x="3" y="1" width="1" height="1"/>
              <rect x="4" y="1" width="1" height="1"/>
              <rect x="5" y="1" width="1" height="1"/>
              <rect x="6" y="1" width="1" height="1"/>
              <rect x="7" y="1" width="1" height="1"/>
              <!-- Row 2: 11111111 -->
              <rect x="0" y="2" width="1" height="1"/>
              <rect x="1" y="2" width="1" height="1"/>
              <rect x="2" y="2" width="1" height="1"/>
              <rect x="3" y="2" width="1" height="1"/>
              <rect x="4" y="2" width="1" height="1"/>
              <rect x="5" y="2" width="1" height="1"/>
              <rect x="6" y="2" width="1" height="1"/>
              <rect x="7" y="2" width="1" height="1"/>
              <!-- Row 3: .111111. -->
              <rect x="1" y="3" width="1" height="1"/>
              <rect x="2" y="3" width="1" height="1"/>
              <rect x="3" y="3" width="1" height="1"/>
              <rect x="4" y="3" width="1" height="1"/>
              <rect x="5" y="3" width="1" height="1"/>
              <rect x="6" y="3" width="1" height="1"/>
              <!-- Row 4: ..1111.. -->
              <rect x="2" y="4" width="1" height="1"/>
              <rect x="3" y="4" width="1" height="1"/>
              <rect x="4" y="4" width="1" height="1"/>
              <rect x="5" y="4" width="1" height="1"/>
              <!-- Row 5: ...11... -->
              <rect x="3" y="5" width="1" height="1"/>
              <rect x="4" y="5" width="1" height="1"/>
            </g>
          </svg>
        </header>
        <p class="mt-3 text-[14.5px] leading-relaxed text-gruv-fg/85">
          If you want to support my Open Source projects or contributions to open collaboration, you can do so via
          <a class="link" href="https://liberapay.com/dotmavriq" target="_blank" rel="noopener noreferrer">Liberapay</a>.
        </p>
        <div class="mt-3">
          <a href="https://liberapay.com/dotmavriq" target="_blank" rel="noopener noreferrer" title="Support on Liberapay">
            <img src="https://img.shields.io/liberapay/receives/dotMavriQ.svg?logo=liberapay" alt="Liberapay receives badge" width="120" height="20" class="inline-block align-middle" loading="lazy" referrerpolicy="no-referrer" />
          </a>
        </div>
      </section>

      <!-- Cal.com card with popup trigger button -->
      <section class="rounded-xl border border-gruv-surface2 bg-gruv-surface/70 p-5 shadow-sm">
        <header>
          <h3 class="text-xl font-semibold tracking-tight text-gruv-fg">Book a meeting</h3>
        </header>
        <p class="mt-3 text-[14.5px] leading-relaxed text-gruv-fg/85">
          Pick a time that works for you. You'll receive a calendar invite with a secure video link.
        </p>
        <div class="mt-4">
          <a id="cal-btn" href="https://cal.com/dotmavriq" class="btn-cta" data-cal-link="dotmavriq" data-cal-config='{"theme":"dark"}'>Book a call</a>
        </div>
      </section>
    </div>

    <!-- Modal: QR code to site -->
    <div id="qr-modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="qr-title" aria-modal="true">
      <div class="modal-backdrop" data-close></div>
      <div class="modal-panel" role="document">
        <header class="flex items-start justify-between gap-4">
          <div>
            <h2 id="qr-title" class="text-lg font-semibold tracking-tight text-gruv-fg">Quick share</h2>
            <p class="mt-1 text-[13px] text-gruv-fg/75">Scan to open this site on your phone.</p>
          </div>
          <button class="close-x" type="button" aria-label="Close" title="Close" data-close>×</button>
        </header>
        <div class="mt-4 flex items-center justify-center">
          <img src="/site_icons/contact_qr.png" alt="QR code to blog.dotMavriQ" width="256" height="256" class="rounded-md border border-gruv-surface2 shadow-md" />
        </div>
        <p class="mt-4 text-center text-xs text-gruv-fg/70">Press Esc or click outside to close.</p>
      </div>
    </div>
  </section>
</BaseLayout>

<script is:inline>
  // Lightweight modal toggling for the QR (triggered only by the folded corner)
  const foldBtn = document.getElementById('fold-trigger');
  const modal = document.getElementById('qr-modal');
  const backdropSel = '[data-close]';
  function getFocusable() {
    if (!modal) return [];
    return [...modal.querySelectorAll('a[href],button:not([disabled]),input:not([disabled]),[tabindex]:not([tabindex="-1"])')];
  }
  function trapFocus(e) {
    if (e.key === 'Escape') { closeModal(); return; }
    if (e.key !== 'Tab') return;
    const focusable = getFocusable();
    if (!focusable.length) return;
    const first = focusable[0], last = focusable[focusable.length - 1];
    if (e.shiftKey) {
      if (document.activeElement === first) { e.preventDefault(); last.focus(); }
    } else {
      if (document.activeElement === last) { e.preventDefault(); first.focus(); }
    }
  }
  function openModal(){
    modal?.setAttribute('aria-hidden','false');
    document.addEventListener('keydown', trapFocus);
    foldBtn?.setAttribute('aria-expanded','true');
    requestAnimationFrame(() => { const f = getFocusable(); if (f.length) f[0].focus(); });
  }
  function closeModal(){
    modal?.setAttribute('aria-hidden','true');
    document.removeEventListener('keydown', trapFocus);
    foldBtn?.setAttribute('aria-expanded','false');
    foldBtn?.focus();
  }
  foldBtn?.addEventListener('click', openModal);
  foldBtn?.addEventListener('keypress', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openModal(); }});
  modal?.addEventListener('click', (e) => { const t = e.target; if (t instanceof HTMLElement && (t.matches(backdropSel) || t.closest(backdropSel))) closeModal(); });

  // Cal.com — only load embed on first button click
  var calBtn = document.getElementById('cal-btn');
  var calLoaded = false;
  if (calBtn) {
    calBtn.addEventListener('click', function(e) {
      e.preventDefault();
      // Clean up any leftover Cal modal DOM from a previous session
      document.querySelectorAll('cal-modal-box').forEach(function(el) { el.remove(); });
      if (!calLoaded) {
        calLoaded = true;
        // Bootstrap Cal global + load embed.js
        (function (C, A, L) {
          var p = function (a, ar) { a.q.push(ar); };
          var d = C.document;
          C.Cal = C.Cal || function () {
            var cal = C.Cal; var ar = arguments;
            if (!cal.loaded) { cal.ns = {}; cal.q = cal.q || []; d.head.appendChild(d.createElement("script")).src = A; cal.loaded = true; }
            if (ar[0] === L) { var api = function () { p(api, arguments); }; var namespace = ar[1]; api.q = api.q || []; if (typeof namespace === "string") { cal.ns[namespace] = cal.ns[namespace] || api; return void p(cal.ns[namespace], ar); } p(cal, ar); return; }
            p(cal, ar);
          };
        })(window, "https://app.cal.com/embed/embed.js", "init");
        Cal("init", {origin: "https://cal.com"});
        Cal("ui", { theme: "dark", styles: { branding: { brandColor: "#fabd2f" } } });
      }
      Cal("modal", { calLink: "dotmavriq", config: { theme: "dark" } });
    });
  }
</script>

<style>
  .link { @apply text-gruv-yellow hover:text-gruv-yellow/90 underline underline-offset-2 decoration-dotted; }
  .btn-cta { @apply inline-flex items-center justify-center px-4 py-2 rounded-lg border border-gruv-surface2 bg-gruv-blue text-gruv-bg font-medium text-sm tracking-tight shadow hover:brightness-110 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-gruv-yellow/40; }

  /* Bite taken out of top-right corner */
  .frayed{ position:relative; overflow:visible; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.35)); }

  /* The bite shape — page-bg colored, punched over the card corner.
     Scalloped edge = tooth marks along a diagonal arc. */
  .bite-shape{
    position:absolute; top:-1px; right:-1px;
    width:100px; height:82px; z-index:3;
    background: #1d2021;
    pointer-events:none;
    clip-path: path('M100,0 L100,76 C96,70 84,64 80,60 C76,56 82,52 88,48 C94,44 82,40 76,36 C70,32 78,28 84,24 C90,20 78,16 72,12 C66,8 62,4 56,0 Z');
  }

  /* Thin shadow strip along the bite edge for depth */
  .bite-edge{
    position:absolute; top:-1px; right:-1px;
    width:100px; height:82px; z-index:4;
    pointer-events:none;
    background: linear-gradient(225deg, transparent 20%, rgba(0,0,0,0.35) 50%, rgba(0,0,0,0.55) 100%);
    clip-path: path('M100,0 L100,76 C97,71 85,66 81,62 C77,58 83,54 89,50 C95,46 83,42 77,38 C71,34 79,30 85,26 C91,22 79,18 73,14 C67,10 63,5 57,1 L56,0 Z');
  }

  /* Hit area over the bite */
  .fold-hit{
    position:absolute; top:0; right:0; width:100px; height:82px;
    background:transparent; cursor:pointer; z-index:5;
    clip-path: path('M100,0 L100,76 C96,70 84,64 80,60 C76,56 82,52 88,48 C94,44 82,40 76,36 C70,32 78,28 84,24 C90,20 78,16 72,12 C66,8 62,4 56,0 Z');
  }
  .fold-hit:hover ~ .surface { filter: brightness(1.05); }
  .fold-hit:focus-visible{ outline:2px solid rgba(250,189,47,0.5); outline-offset:2px; border-radius:0.5rem; }

  .contact-card .surface{ position:relative; z-index:1; }

  /* Scattered crumb dots near the bite */
  .bite-crumbs{ position:absolute; top:0; right:0; width:110px; height:95px; z-index:2; pointer-events:none; }
  .bite-crumbs span{ position:absolute; display:block; background:#504945; border-radius:50%; }

  /* Modal styles */
  #qr-modal[aria-hidden="true"] { display:none; }
  #qr-modal{ position:fixed; inset:0; z-index:60; display:grid; place-items:center; overscroll-behavior:contain; }
  #qr-modal .modal-backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.55); backdrop-filter: blur(2px); }
  #qr-modal .modal-panel{
    position:relative; width:min(92vw, 520px);
    @apply rounded-xl border border-gruv-surface2 bg-gruv-surface p-5 shadow-lg;
  }
  .close-x{ @apply inline-flex items-center justify-center w-8 h-8 rounded-md border border-gruv-surface2 bg-gruv-surface2/40 text-gruv-fg hover:bg-gruv-surface2; }

</style>

