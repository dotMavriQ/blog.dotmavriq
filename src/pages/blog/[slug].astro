---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const posts = await getCollection("blog");
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content, headings } = await post.render();

// Prev/next by date (non-draft only)
const allPosts = (await getCollection("blog"))
  .filter((p) => !p.data.draft)
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const currentIndex = allPosts.findIndex((p) => p.slug === post.slug);
const prevPost = currentIndex < allPosts.length - 1 ? allPosts[currentIndex + 1] : null;
const nextPost = currentIndex > 0 ? allPosts[currentIndex - 1] : null;

// Reading time estimate
const wordCount = post.body?.split(/\s+/).length || 0;
const readingTime = Math.max(1, Math.ceil(wordCount / 200));

// Filter to h2/h3 for ToC
const tocHeadings = headings.filter((h) => h.depth === 2 || h.depth === 3);
---

<BaseLayout
  title={`${post.data.title} · dotMavriQ`}
  description={post.data.excerpt || `Blog post: ${post.data.title}`}
>
  <article class="relative z-30 max-w-6xl mx-auto px-5 md:px-8 py-10 md:py-14">
    <div class="lg:flex lg:gap-10">
      <!-- Main content -->
      <div class="flex-1 min-w-0 max-w-3xl mx-auto lg:mx-0">
        <!-- Post header -->
        <header class="mb-8">
          {post.data.heroImage && (
            <div class="relative aspect-video overflow-hidden rounded-xl mb-6 bg-gruv-bg/40">
              <img
                src={post.data.heroImage}
                alt={post.data.title}
                width="1536"
                height="1024"
                loading="eager"
                fetchpriority="high"
                decoding="async"
                class="w-full h-full object-cover object-center brightness-[0.97] contrast-[0.97] saturate-[0.92] blur-[0.4px]"
              />
              <div class="absolute inset-0 bg-gradient-to-t from-[#1d2021]/60 via-transparent to-transparent pointer-events-none"></div>
            </div>
          )}
          <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight text-gruv-fg">{post.data.title}</h1>
          <div class="mt-3 flex flex-wrap items-center gap-3 font-mono text-sm text-gruv-muted">
            <time datetime={post.data.pubDate.toISOString()} style="font-variant-numeric: tabular-nums;">
              {new Intl.DateTimeFormat("en-GB", { day: "numeric", month: "short", year: "numeric" }).format(post.data.pubDate)}
            </time>
            <span aria-hidden="true">·</span>
            <span>{readingTime} min read</span>
            {post.data.tags.length > 0 && (
              <>
                <span aria-hidden="true">·</span>
                <div class="flex flex-wrap gap-1.5">
                  {post.data.tags.map((tag) => (
                    <a
                      href={`/blog/?tags=${encodeURIComponent(tag)}`}
                      class="text-[10px] font-mono px-2 py-0.5 rounded-md bg-[#504945]/80 border border-[#bdae93]/30 text-[#ebdbb2] shadow-[0_0_0_1px_rgba(0,0,0,0.25)] tracking-wide hover:bg-gruv-yellow hover:text-gruv-bg hover:border-gruv-yellow transition-colors"
                    >
                      {tag}
                    </a>
                  ))}
                </div>
              </>
            )}
          </div>
        </header>

        <!-- Mobile ToC -->
        {tocHeadings.length > 1 && (
          <details class="lg:hidden mb-8 rounded-lg border border-gruv-surface2/70 bg-gruv-surface">
            <summary class="px-4 py-3 text-sm font-medium text-gruv-fg cursor-pointer select-none hover:text-gruv-yellow transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-gruv-yellow/50 rounded-lg">
              Table of Contents
            </summary>
            <nav class="px-4 pb-4" aria-label="Table of contents">
              <ul class="space-y-1.5">
                {tocHeadings.map((h) => (
                  <li class={h.depth === 3 ? "ml-4" : ""}>
                    <a
                      href={`#${h.slug}`}
                      class="text-sm text-gruv-muted hover:text-gruv-yellow transition-colors block py-0.5 border-l-2 border-gruv-surface2 pl-3 hover:border-gruv-yellow"
                    >
                      {h.text}
                    </a>
                  </li>
                ))}
              </ul>
            </nav>
          </details>
        )}

        <!-- Post body -->
        <div class="blog-prose-wrapper">
          <div class="blog-prose">
            <Content />
          </div>
        </div>

        <!-- Post navigation -->
        <nav class="mt-12 pt-8 border-t border-gruv-surface2/70 flex flex-col sm:flex-row gap-4 sm:justify-between" aria-label="Post navigation">
          {prevPost ? (
            <a href={`/blog/${prevPost.slug}/`} class="group flex flex-col gap-1 text-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-gruv-yellow/50 rounded px-2 py-1 -mx-2">
              <span class="text-gruv-muted text-xs font-mono">&larr; Previous</span>
              <span class="text-gruv-fg group-hover:text-gruv-yellow transition-colors">{prevPost.data.title}</span>
            </a>
          ) : <div />}
          {nextPost ? (
            <a href={`/blog/${nextPost.slug}/`} class="group flex flex-col gap-1 text-sm text-right focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-gruv-yellow/50 rounded px-2 py-1 -mx-2">
              <span class="text-gruv-muted text-xs font-mono">Next &rarr;</span>
              <span class="text-gruv-fg group-hover:text-gruv-yellow transition-colors">{nextPost.data.title}</span>
            </a>
          ) : <div />}
        </nav>

        <div class="mt-6 mb-14">
          <a href="/blog/" class="text-sm font-mono text-gruv-muted hover:text-gruv-yellow transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-gruv-yellow/50 rounded px-2 py-1 -mx-2">
            &larr; Back to Blog
          </a>
        </div>

        <!-- Comments -->
        <section class="mt-2 pt-8 border-t border-gruv-surface2/70" id="comments">
          <h2 class="text-lg font-semibold text-gruv-fg mb-6 font-sans">Comments</h2>
          <div class="giscus-wrapper rounded-lg overflow-hidden">
            <script
              src="https://giscus.app/client.js"
              data-repo="dotMavriQ/blog.dotmavriq"
              data-repo-id="R_kgDON7yaLg"
              data-category="Announcements"
              data-category-id="DIC_kwDON7yaLs4C2kxf"
              data-mapping="pathname"
              data-strict="0"
              data-reactions-enabled="1"
              data-emit-metadata="0"
              data-input-position="top"
              data-theme="https://giscus.app/themes/transparent_dark.css"
              data-lang="en"
              data-loading="lazy"
              crossorigin="anonymous"
              async
              is:inline
            ></script>
          </div>
        </section>
      </div>

      <!-- Desktop ToC sidebar -->
      {tocHeadings.length > 1 && (
        <aside class="hidden lg:block w-56 xl:w-64 shrink-0">
          <nav class="sticky top-20 rounded-lg border border-gruv-surface2/70 bg-gruv-surface p-4" aria-label="Table of contents">
            <h2 class="text-xs font-mono font-semibold text-gruv-muted uppercase tracking-wider mb-3">Contents</h2>
            <ul class="space-y-1.5" id="toc-list">
              {tocHeadings.map((h) => (
                <li class={h.depth === 3 ? "ml-3" : ""}>
                  <a
                    href={`#${h.slug}`}
                    class="toc-link text-sm text-gruv-muted hover:text-gruv-yellow transition-colors block py-0.5 border-l-2 border-gruv-surface2 pl-3"
                    data-heading={h.slug}
                  >
                    {h.text}
                  </a>
                </li>
              ))}
            </ul>
          </nav>
        </aside>
      )}
    </div>
  </article>
</BaseLayout>

<script>
  // Scroll-spy for desktop ToC
  const tocLinks = document.querySelectorAll<HTMLAnchorElement>('.toc-link');
  if (tocLinks.length) {
    const headingEls = Array.from(tocLinks).map((link) =>
      document.getElementById(link.dataset.heading || '')
    ).filter(Boolean) as HTMLElement[];

    let currentId = '';

    const observer = new IntersectionObserver(
      (entries) => {
        for (const entry of entries) {
          if (entry.isIntersecting) {
            currentId = entry.target.id;
            break;
          }
        }
        tocLinks.forEach((link) => {
          const isActive = link.dataset.heading === currentId;
          link.classList.toggle('toc-active', isActive);
        });
      },
      {
        rootMargin: '-80px 0px -70% 0px',
        threshold: 0,
      }
    );

    headingEls.forEach((el) => observer.observe(el));
  }

  // Smooth scroll for ToC clicks
  document.querySelectorAll<HTMLAnchorElement>('a[href^="#"]').forEach((a) => {
    a.addEventListener('click', (e) => {
      const id = a.getAttribute('href')?.slice(1);
      if (!id) return;
      const target = document.getElementById(id);
      if (!target) return;
      e.preventDefault();
      target.scrollIntoView({ behavior: 'smooth', block: 'start' });
      history.replaceState(null, '', `#${id}`);
    });
  });
</script>

<style>
  /* ToC active state */
  .toc-active {
    color: #fabd2f !important;
    font-weight: 600;
    border-left-color: #fabd2f !important;
  }

  @media (prefers-reduced-motion: reduce) {
    .toc-link {
      transition: none !important;
    }
  }
</style>

<style is:global>
  /* ── Reading surface ── */
  .blog-prose-wrapper {
    background: #fbf1c7;
    border-radius: 0.75rem;
    padding: 2.5rem 2rem;
    box-shadow:
      0 1px 3px rgba(0,0,0,0.12),
      0 0 0 1px rgba(60,56,54,0.08);
  }
  @media (min-width: 640px) {
    .blog-prose-wrapper {
      padding: 3rem 2.75rem;
    }
  }
  @media (min-width: 768px) {
    .blog-prose-wrapper {
      padding: 3.5rem 3.25rem;
    }
  }

  /* ── Prose typography ── */
  .blog-prose {
    font-family: 'Literata', 'Charter', 'Georgia', serif;
    font-size: 1.125rem;
    line-height: 1.9;
    color: #3c3836;
    max-width: 65ch;
    font-optical-sizing: auto;
    -webkit-font-smoothing: antialiased;
    text-rendering: optimizeLegibility;
    hanging-punctuation: first last;
  }

  /* Headings — Inter for contrast against serif body */
  .blog-prose h2,
  .blog-prose h3,
  .blog-prose h4 {
    font-family: 'Inter', system-ui, sans-serif;
    color: #282828;
    font-weight: 700;
    scroll-margin-top: 5rem;
    letter-spacing: -0.02em;
    line-height: 1.3;
  }
  .blog-prose h2 {
    font-size: 1.625rem;
    margin-top: 2.5em;
    margin-bottom: 0.8em;
    padding: 0.6rem 0 0.6rem 1rem;
    border-left: 4px solid #b57614;
    background: linear-gradient(90deg, rgba(213,196,161,0.45) 0%, transparent 70%);
    border-radius: 0 0.25rem 0.25rem 0;
  }
  .blog-prose h2:first-child {
    margin-top: 0;
  }
  .blog-prose h3 {
    font-size: 1.3rem;
    margin-top: 2em;
    margin-bottom: 0.6em;
    padding-left: 0.85rem;
    border-left: 3px solid #928374;
    color: #504945;
  }

  /* Paragraphs */
  .blog-prose p {
    margin-bottom: 1.5em;
  }

  /* Links */
  .blog-prose a {
    color: #076678;
    text-decoration: underline;
    text-decoration-color: rgba(7,102,120,0.35);
    text-underline-offset: 3px;
    text-decoration-thickness: 1.5px;
    transition: color .15s ease, text-decoration-color .15s ease;
  }
  .blog-prose a:hover {
    color: #b57614;
    text-decoration-color: #b57614;
  }

  /* Bold */
  .blog-prose strong {
    color: #282828;
    font-weight: 600;
  }

  /* Blockquotes */
  .blog-prose blockquote {
    border-left: 3px solid #b57614;
    padding-left: 1.25rem;
    margin-left: 0;
    margin-bottom: 1.5em;
    font-style: italic;
    color: #504945;
  }

  /* Lists */
  .blog-prose ul,
  .blog-prose ol {
    padding-left: 1.5rem;
    margin-bottom: 1.5em;
  }
  .blog-prose ul {
    list-style-type: disc;
  }
  .blog-prose ol {
    list-style-type: decimal;
  }
  .blog-prose li {
    margin-bottom: 0.5em;
    padding-left: 0.25em;
  }
  .blog-prose li::marker {
    color: #928374;
  }

  /* Inline code */
  .blog-prose code:not(pre code) {
    background: #ebdbb2;
    color: #9d0006;
    padding: 0.15rem 0.4rem;
    border-radius: 0.25rem;
    font-family: 'JetBrains Mono', 'Fira Code', monospace;
    font-size: 0.85em;
    border: 1px solid #d5c4a1;
  }

  /* Code blocks — keep dark for contrast */
  .blog-prose pre {
    background: #282828;
    color: #ebdbb2;
    border-radius: 0.5rem;
    padding: 1.25rem 1.5rem;
    overflow-x: auto;
    margin-bottom: 1.5em;
    font-size: 0.875rem;
    line-height: 1.7;
    border: 1px solid #3c3836;
  }

  /* Images */
  .blog-prose img {
    border-radius: 0.5rem;
    margin: 2em auto;
    display: block;
    max-width: 100%;
    height: auto;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  /* Horizontal rules */
  .blog-prose hr {
    border: none;
    border-top: 2px solid #d5c4a1;
    margin: 2.5em 0;
  }

  /* Tables */
  .blog-prose table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 1.5em;
    font-size: 0.9rem;
  }
  .blog-prose th {
    text-align: left;
    font-family: 'Inter', system-ui, sans-serif;
    font-weight: 600;
    padding: 0.6rem 0.75rem;
    border-bottom: 2px solid #bdae93;
    color: #282828;
  }
  .blog-prose td {
    padding: 0.6rem 0.75rem;
    border-bottom: 1px solid #d5c4a1;
  }

  /* ── Giscus comments ── */
  .giscus-wrapper {
    border: 1px solid rgba(50,48,47,0.7);
    border-radius: 0.5rem;
    padding: 0.5rem;
    background: rgba(40,40,40,0.4);
  }
  .giscus-wrapper .giscus {
    max-width: 100%;
  }
  .giscus-frame {
    border-radius: 0.375rem;
  }
</style>
